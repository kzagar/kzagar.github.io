(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const u of l.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&r(u)}).observe(document,{childList:!0,subtree:!0});function o(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function r(i){if(i.ep)return;i.ep=!0;const l=o(i);fetch(i.href,l)}})();class w{constructor(n,o){this.start=n,this.end=o}static fromJSON(n){return new w(new Date(n.start),new Date(n.end))}toJSON(){return{start:this.start.toISOString(),end:this.end.toISOString()}}getDuration(){return(this.end.getTime()-this.start.getTime())/1e3}}class L{constructor(n,o=new Date().toISOString()){this.content=n,this.time=o}static fromJSON(n){return new L(n.content,n.time)}toJSON(){return{content:this.content,time:this.time}}}class N{constructor(n,o,r=0,i=[],l=[]){this.id=n,this.name=o,this.time=r,this.journals=i.map(u=>L.fromJSON(u)),this.intervals=l.map(u=>w.fromJSON(u)),this.totalIntervalTime=this.calculateTotalIntervalTime()}updateName(n){this.name=n}addJournal(n){const o=new L(n);return this.journals.push(o),o}addInterval(n,o){const r=new w(n,o);return this.intervals.push(r),this.totalIntervalTime+=r.getDuration(),r}updateInterval(n,o,r){if(n>=0&&n<this.intervals.length){const i=this.intervals[n];this.totalIntervalTime-=i.getDuration();const l=new w(o,r);return this.intervals[n]=l,this.totalIntervalTime+=l.getDuration(),!0}return!1}getIntervals(){return this.intervals.slice()}calculateTotalIntervalTime(){let n=0;return this.intervals.forEach(o=>{n+=o.getDuration()}),Math.floor(n)}static fromJSON(n){const o=new N(n.id,n.name,n.time,n.journals,n.intervals);return o.totalIntervalTime=o.calculateTotalIntervalTime(),o}toJSON(){return{id:this.id,name:this.name,time:this.time,journals:this.journals.map(n=>n.toJSON()),intervals:this.intervals.map(n=>n.toJSON())}}}class E{constructor(n=[],o=1){this.tasks=n.map(r=>N.fromJSON(r)),this.nextTaskId=o}addTask(n){const o=new N(this.nextTaskId++,n.trim());return this.tasks.unshift(o),o}deleteTask(n){return this.tasks.find(r=>r.id===n)?(this.tasks=this.tasks.filter(r=>r.id!==n),!0):!1}findTask(n){return this.tasks.find(o=>o.id===n)}updateTaskName(n,o){const r=this.findTask(n);return r?(r.updateName(o),!0):!1}addJournalEntry(n,o){const r=this.findTask(n);return r?(r.addJournal(o),!0):!1}getAllTasks(){return this.tasks}toJSON(){return{tasks:this.tasks.map(n=>n.toJSON()),nextTaskId:this.nextTaskId}}static fromJSON(n){return new E(n.tasks,n.nextTaskId)}}document.addEventListener("DOMContentLoaded",()=>{const m=document.querySelector("#task-table tbody"),n=document.querySelector("#task-row-template"),o=document.querySelector("#new-task-row .new-task-input");let r=new E,i=-1,l=null,u=null,g=[],S=null,p=[],T=null,b=0;function D(t){const e=Math.floor(t/3600),s=Math.floor(t%3600/60),a=t%60,c=d=>d.toString().padStart(2,"0");return e>0?`${e}:${c(s)}:${c(a)}`:`${s}:${c(a)}`}function R(){const t=localStorage.getItem("chronosTasks"),e=localStorage.getItem("chronosTaskOrder"),s=localStorage.getItem("chronosRunningTaskId"),a=localStorage.getItem("chronosRunningTaskStartTime"),c=localStorage.getItem("chronosTasksWithVisibleJournals");if(t?r=E.fromJSON(JSON.parse(t)):(r=new E,r.addTask("Task 1"),r.addTask("Task 2"),r.addTask("Task 3")),e?g=JSON.parse(e):g=r.getAllTasks().map(d=>d.id),s!==null){i=parseInt(s,10);const d=r.findTask(i);if(d){if(a){const f=new Date(a),h=(new Date().getTime()-f.getTime())/1e3;d.totalIntervalTime+=h}l=new Date,u=setInterval(()=>{const f=l?(new Date().getTime()-l.getTime())/1e3:0,h=d.totalIntervalTime+f,k=document.querySelector(`tr[data-id='${d.id}'] .task-time`);k&&(k.textContent=D(Math.floor(h))),y()},1e3)}else i=-1,l=null}c&&(p=JSON.parse(c))}function M(){const t=localStorage.getItem("chronosLastFetchedTimestamp");t&&(b=parseInt(t,10))}function y(){localStorage.setItem("chronosTasks",JSON.stringify(r)),localStorage.setItem("chronosTaskOrder",JSON.stringify(g)),localStorage.setItem("chronosRunningTaskId",i.toString()),localStorage.setItem("chronosTasksWithVisibleJournals",JSON.stringify(p)),localStorage.setItem("chronosLastFetchedTimestamp",b.toString())}function I(){const t=document.getElementById("new-task-row");Array.from(m.children).forEach(e=>{e.id!=="new-task-row"&&e.remove()}),m.firstChild!==t&&t&&m.prepend(t);for(let e=g.length-1;e>=0;e--){const s=g[e],a=r.findTask(s);if(!a)continue;const c=n.content.cloneNode(!0),d=c.querySelector("tr");d.dataset.id=a.id.toString();const f=c.querySelector(".task-name");f.textContent=a.name,f.contentEditable="true",f.dataset.taskId=a.id.toString();const h=c.querySelector(".task-time"),k=a.totalIntervalTime+(a.id===i&&l?(new Date().getTime()-l.getTime())/1e3:0);h.textContent=D(Math.floor(k));const v=c.querySelector(".start-pause-btn");v.textContent=a.id===i?"❚❚":"▶";const O=c.querySelector(".show-journal-checkbox");O.checked=p.includes(a.id),O.dataset.taskId=a.id.toString(),t&&m.insertBefore(c,t.nextSibling)}}function A(t){const e=r.findTask(t);if(e){if(i===t)u&&(clearInterval(u),u=null),l&&(e.addInterval(l,new Date),l=null,localStorage.setItem("chronosRunningTaskStartTime","")),i=-1;else{if(i!==-1){const s=r.findTask(i);s&&u&&(clearInterval(u),u=null,l&&s.addInterval(l,new Date))}i=t,l=new Date,localStorage.setItem("chronosRunningTaskStartTime",l.toISOString()),u=setInterval(()=>{const s=l?(new Date().getTime()-l.getTime())/1e3:0,a=e.totalIntervalTime+s,c=document.querySelector(`tr[data-id='${e.id}'] .task-time`);c&&(c.textContent=D(Math.floor(a))),y()},1e3)}y(),I()}}function $(t,e){r.updateTaskName(t,e)&&y()}function W(t){if(t.trim()==="")return;const e=r.addTask(t);g.unshift(e.id),y(),I(),o.textContent=""}function H(t){const e=r.findTask(t);e&&confirm(`Are you sure you want to delete "${e.name}"?`)&&r.deleteTask(t)&&(g=g.filter(s=>s!==t),i===t&&(u&&(clearInterval(u),u=null),l=null,i=-1,localStorage.setItem("chronosRunningTaskStartTime","")),p=p.filter(s=>s!==t),y(),I(),J())}m.addEventListener("click",t=>{const e=t.target,s=e.closest("tr");if(!s)return;const a=parseInt(s.dataset.id,10);e.classList.contains("start-pause-btn")?A(a):e.classList.contains("journal-btn")?(S=a,V()):e.classList.contains("delete-btn")?H(a):e.classList.contains("show-journal-checkbox")&&(e.checked?p.includes(a)||p.push(a):p=p.filter(c=>c!==a),y(),J())}),m.addEventListener("keydown",t=>{if(t.target.classList.contains("task-name")){if(t.key==="Enter")t.preventDefault(),t.target.blur();else if(t.key==="Escape"){const e=r.findTask(parseInt(t.target.dataset.taskId));e&&(t.target.textContent=e.name),t.target.blur()}}else t.target.classList.contains("new-task-input")&&t.key==="Enter"&&(t.preventDefault(),W(t.target.textContent||""))}),m.addEventListener("blur",t=>{if(t.target.classList.contains("task-name")){const e=parseInt(t.target.dataset.taskId,10),s=(t.target.textContent||"").trim();$(e,s)}},!0),m.addEventListener("dragstart",t=>{t.target.tagName==="TR"&&t.target.id!=="new-task-row"&&(T=t.target,t.dataTransfer.effectAllowed="move",setTimeout(()=>{T&&(T.style.opacity="0.5")},0))}),m.addEventListener("dragover",t=>{if(t.preventDefault(),t.target&&t.target.closest("tr")&&t.target.closest("tr").id!=="new-task-row"&&T){const e=t.target.closest("tr");if(e!==T){const s=e.getBoundingClientRect(),a=s.y+s.height/2;t.clientY>a?(e.style.borderBottom="2px solid blue",e.style.borderTop=""):(e.style.borderTop="2px solid blue",e.style.borderBottom="")}}}),m.addEventListener("dragleave",t=>{t.target&&t.target.closest("tr")&&(t.target.closest("tr").style.borderTop="",t.target.closest("tr").style.borderBottom="")}),m.addEventListener("drop",t=>{if(t.preventDefault(),t.target&&t.target.closest("tr")&&t.target.closest("tr").id!=="new-task-row"&&T){const e=t.target.closest("tr"),s=parseInt(e.dataset.id,10),a=parseInt(T.dataset.id,10),c=g.indexOf(a),d=g.indexOf(s);c!==-1&&d!==-1&&(g.splice(c,1),g.splice(d,0,a),y()),I()}T&&(T.style.opacity=""),t.target&&t.target.closest("tr")&&(t.target.closest("tr").style.borderTop="",t.target.closest("tr").style.borderBottom="")}),m.addEventListener("dragend",t=>{T&&(T.style.opacity=""),m.querySelectorAll("tr").forEach(e=>{e.style.borderTop="",e.style.borderBottom=""}),T=null}),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("sw.js").then(t=>{console.log("Service Worker registered: ",t)}).catch(t=>{console.log("Service Worker registration failed: ",t)})});const x=document.getElementById("journal-dialog"),C=document.getElementById("journal-input"),P=document.getElementById("add-journal-btn"),F=document.getElementById("discard-journal-btn");function V(){x.style.display="flex",C.value="",C.focus()}function j(){x.style.display="none",C.value="",S=null}function q(){const t=C.value.trim();if(t===""){alert("Journal entry cannot be empty.");return}if(S===null){alert("No task selected for journal entry.");return}if(r.addJournalEntry(S,t)){y(),j();const e=r.findTask(S);console.log("Journal Entries for Task:",e?e.journals:"Task not found"),J()}else alert("Selected task not found.")}P.addEventListener("click",q),F.addEventListener("click",j),x.addEventListener("keydown",t=>{t.key==="Escape"?j():t.key==="Enter"&&t.ctrlKey&&(t.preventDefault(),q())});function K(t){const e=new Date(t),s={weekday:"short",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"};return e.toLocaleString("en-US",s)}function J(){const t=document.querySelector("#journal-entries-table tbody"),e=document.querySelector("#journal-entry-template"),s=document.querySelector(".main-container");t.innerHTML="";const a=r.getAllTasks().filter(c=>p.includes(c.id));a.length>0?(s.classList.add("show-journals"),a.forEach(c=>{const d=c.journals;if(d.length>0){const f=document.createElement("tr"),h=document.createElement("td");h.colSpan=2,h.innerHTML=`<strong>Task: ${c.name}</strong>`,f.appendChild(h),t.appendChild(f),d.sort((k,v)=>new Date(k.time).getTime()-new Date(v.time).getTime()),d.forEach(k=>{const v=e.content.cloneNode(!0),O=v.querySelector(".journal-time"),Y=v.querySelector(".journal-content");O.textContent=K(k.time),Y.textContent=k.content,t.appendChild(v)})}})):s.classList.remove("show-journals")}async function B(){try{const t=await fetch(`http://localhost:18976/activity?since=${b}`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const e=await t.json();U(e),b=new Date().getTime(),y()}catch(t){console.error("Error fetching activities:",t)}}function U(t){const e=document.querySelector("#activity-table tbody");if(e.innerHTML="",t.length===0){const s=document.createElement("tr"),a=document.createElement("td");a.colSpan=3,a.textContent="No recent activities.",s.appendChild(a),e.appendChild(s);return}t.forEach(s=>{const a=document.createElement("tr"),c=document.createElement("td");c.textContent=s.title,a.appendChild(c);const d=document.createElement("td");d.textContent=new Date(s.start_time).toLocaleString(),a.appendChild(d);const f=document.createElement("td"),h=Math.floor(s.duration/6e4),k=Math.floor(s.duration%6e4/1e3);f.textContent=`${h}m ${k}s`,a.appendChild(f),e.appendChild(a)})}R(),I(),J(),M(),B(),setInterval(B,5e3)});
