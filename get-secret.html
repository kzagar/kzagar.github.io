<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reconstruct Shamir's Secret</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .share-input-container {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #eee;
        }
        .share-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .share-input-group input[type="text"] {
            flex-grow: 1;
            margin-right: 10px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        }
        .share-input-group button {
            width: auto; /* Don't take full width */
            padding: 10px 15px;
        }
        #reconstructedSecretArea {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #d4edda;
            border-radius: 6px;
            background-color: #d4edda; /* Light green for success */
            color: #155724;
        }
        #reconstructedSecretArea h2 {
            margin-top: 0;
            color: #155724;
        }
        #reconstructedSecretValue {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 1.1em;
            word-break: break-all;
            background-color: #fff;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #c3e6cb;
        }
        #statusMessages {
            margin-top: 15px;
            font-style: italic;
            color: #555;
        }
        .error-message {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Reconstruct Secret</h1>

        <div id="sharesInputArea">
            <!-- Share input groups will be added here -->
        </div>

        <div id="reconstructedSecretArea" style="display: none;">
            <h2>Reconstructed Secret:</h2>
            <div id="reconstructedSecretValue"></div>
        </div>

        <div id="statusMessages">
            Enter the first share part.
        </div>
    </div>

    <script src="js/shamir.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sharesInputArea = document.getElementById('sharesInputArea');
            const reconstructedSecretArea = document.getElementById('reconstructedSecretArea');
            const reconstructedSecretValue = document.getElementById('reconstructedSecretValue');
            const statusMessages = document.getElementById('statusMessages');

            let collectedValidShares = [];
            let shareCounter = 0;

            const CHARSET_VALIDATOR = /^[1-9A-Z\-]*$/; // Allows 1-9, A-Z, and hyphen

            function canonicalizeShare(rawShare) {
                // 1. Uppercase
                let processed = rawShare.toUpperCase();
                // 2. Remove characters not in CHARSET or hyphen
                processed = Array.from(processed).filter(char => CHARSET_VALIDATOR.test(char)).join('');
                // 3. Compact multiple hyphens and trim leading/trailing hyphens (optional, but good for robustness)
                processed = processed.replace(/-+/g, '-').replace(/^-+|-+$/g, '');
                return processed;
            }

            function addShareInputGroup() {
                shareCounter++;
                const containerDiv = document.createElement('div');
                containerDiv.className = 'share-input-container';
                containerDiv.id = `share_container_${shareCounter}`;

                const groupDiv = document.createElement('div');
                groupDiv.className = 'share-input-group';

                const label = document.createElement('label');
                label.setAttribute('for', `share_input_${shareCounter}`);
                label.textContent = `Share Part ${shareCounter}:`;
                label.style.marginRight = '10px'; // Add some spacing

                const input = document.createElement('input');
                input.type = 'text';
                input.id = `share_input_${shareCounter}`;
                input.placeholder = 'Enter share part (e.g., A1B2-C3D4-E)';
                
                const addButton = document.createElement('button');
                addButton.textContent = 'Add & Try Reconstruct';
                addButton.type = 'button';
                addButton.id = `add_button_${shareCounter}`;

                addButton.addEventListener('click', () => {
                    const rawShare = input.value.trim();
                    if (!rawShare) {
                        alert('Please enter a share part.');
                        return;
                    }

                    const canonicalShare = canonicalizeShare(rawShare);
                    input.value = canonicalShare; // Show user the canonical form

                    // Simpler check: ensure Shamir object and its core reconstruct method exist.
                    // parseShareInputString is not directly exposed by the Shamir module, it's internal.
                    if (typeof Shamir === 'undefined' || typeof Shamir.reconstruct !== 'function') {
                        statusMessages.textContent = 'Error: shamir.js library not loaded correctly or is missing reconstruct function.';
                        statusMessages.className = 'error-message';
                        return;
                    }
                    
                    let isFirstShareProcessing = (collectedValidShares.length === 0 && !document.body.dataset.requiredT);
                    let currentShareValidForAdding = true;

                    if (isFirstShareProcessing) {
                        try {
                            Shamir.reconstruct([canonicalShare]); // Expect this to fail for t > 1
                        } catch (testError) {
                            if (testError.message.includes("Not enough shares provided")) {
                                const match = testError.message.match(/Required: (\d+)/);
                                if (match && match[1]) {
                                    const requiredT = parseInt(match[1]);
                                    document.body.dataset.requiredT = requiredT.toString();
                                    statusMessages.textContent = `First share processed. This set requires ${requiredT} parts. Adding remaining input boxes.`;
                                    statusMessages.className = '';
                                    const currentNumberOfInputGroups = sharesInputArea.querySelectorAll('.share-input-container').length;
                                    for (let i = currentNumberOfInputGroups; i < requiredT; i++) { // Add up to 'requiredT' boxes
                                        addShareInputGroup();
                                    }
                                } else {
                                     statusMessages.textContent = "Could not determine required shares from first part. Proceeding normally.";
                                }
                            } else { // First share itself is malformed
                                currentShareValidForAdding = false;
                                statusMessages.textContent = `Error with first share part: ${testError.message}`;
                                statusMessages.className = 'error-message';
                                alert(statusMessages.textContent);
                            }
                        }
                    }

                    if (!currentShareValidForAdding) {
                        return; // Stop if the first share was malformed
                    }

                    // Add the current share (if not already added and valid)
                    if (!collectedValidShares.includes(canonicalShare)) {
                        collectedValidShares.push(canonicalShare);
                    }
                    
                    input.readOnly = true;
                    addButton.disabled = true;
                    addButton.textContent = 'Added';
                    
                    if (reconstructedSecretArea.style.display !== 'block') {
                         statusMessages.textContent = `Share part ${shareCounter} added. Total valid shares: ${collectedValidShares.length}. Attempting reconstruction...`;
                         statusMessages.className = '';
                    }

                    // Attempt actual reconstruction
                    try {
                        const reconstructedSecret = Shamir.reconstruct(collectedValidShares);
                        reconstructedSecretValue.textContent = reconstructedSecret;
                        reconstructedSecretArea.style.display = 'block';
                        statusMessages.textContent = `Secret reconstructed successfully with ${collectedValidShares.length} share(s)!`;
                        statusMessages.className = 'success';
                        // Do not add more input groups if successful
                    } catch (e) {
                        // Handle reconstruction errors (e.g., not enough shares yet, inconsistent shares, malformed share detected by reconstruct)
                        statusMessages.textContent = `Reconstruction failed: ${e.message}`;
                        statusMessages.className = 'error-message';
                        alert(statusMessages.textContent);

                        // If reconstruction failed because *this specific share* was malformed (and reconstruct caught it)
                        // we should ideally revert its addition and re-enable the input.
                        // This is tricky because reconstruct processes all shares.
                        // For now, if it's a general error, we assume the user needs to add more or check previous.
                        // The "Added" state of the button/input remains.

                        const knownT = parseInt(document.body.dataset.requiredT || "0");
                        const currentInputsCount = sharesInputArea.querySelectorAll('.share-input-container').length;
                        if (reconstructedSecretArea.style.display !== 'block') { // If not yet successful
                           if (knownT > 0 && currentInputsCount < knownT) {
                                // This case should ideally not be hit if pre-population worked,
                                // but as a fallback, or if user deletes boxes.
                                addShareInputGroup();
                           } else if (knownT === 0 && currentInputsCount === collectedValidShares.length) {
                                // 't' is unknown, and we just processed the last available box, add another.
                                addShareInputGroup();
                           }
                        }
                    }
                });
                
                groupDiv.appendChild(label);
                groupDiv.appendChild(input);
                groupDiv.appendChild(addButton);
                containerDiv.appendChild(groupDiv);
                sharesInputArea.appendChild(containerDiv);
                input.focus(); // Focus the new input field
            }

            // Add the first share input group
            addShareInputGroup();
        });
    </script>
</body>
</html>